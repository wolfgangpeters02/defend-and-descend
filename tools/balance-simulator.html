<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defend & Descend - Balance Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a24;
            --accent-cyan: #00d4ff;
            --accent-purple: #a855f7;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --border: #27272a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'SF Mono', 'Fira Code', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--accent-cyan);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover { border-color: var(--accent-cyan); }
        .tab.active {
            background: var(--accent-cyan);
            color: var(--bg-dark);
            border-color: var(--accent-cyan);
        }

        .panel { display: none; }
        .panel.active { display: block; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .card h3 {
            color: var(--accent-cyan);
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-intro {
            background: var(--bg-input);
            border-left: 3px solid var(--accent-cyan);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            line-height: 1.6;
        }

        .section-intro h2 {
            color: var(--accent-cyan);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .section-intro p {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .section-intro .formula {
            background: var(--bg-dark);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            color: var(--accent-yellow);
            margin: 8px 0;
            display: inline-block;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .input-group .input-help {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group { flex: 1; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .chart-container.tall { height: 400px; }

        .chart-description {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .chart-description strong {
            color: var(--accent-cyan);
        }

        .chart-description .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-top: 8px;
        }

        .chart-description .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 6px;
        }

        button {
            padding: 10px 20px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 6px;
            color: var(--bg-dark);
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover { opacity: 0.8; }
        button.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-box {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .stat-help {
            font-size: 9px;
            color: #555;
            margin-top: 2px;
        }

        .simulation-log {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-entry { margin-bottom: 4px; }
        .log-entry.drop { color: var(--accent-green); }
        .log-entry.no-drop { color: var(--text-secondary); }
        .log-entry.legendary { color: var(--accent-yellow); }
        .log-entry.first-kill { color: var(--accent-purple); }

        .drop-results {
            margin-top: 15px;
        }

        .drop-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .drop-bar-label {
            width: 120px;
            font-size: 12px;
        }

        .drop-bar-track {
            flex: 1;
            height: 20px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .drop-bar-fill {
            height: 100%;
            background: var(--accent-cyan);
            transition: width 0.3s;
        }

        .drop-bar-value {
            width: 60px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .rarity-common .drop-bar-fill { background: #71717a; }
        .rarity-rare .drop-bar-fill { background: #3b82f6; }
        .rarity-epic .drop-bar-fill { background: #a855f7; }
        .rarity-legendary .drop-bar-fill { background: #eab308; }

        .export-area {
            width: 100%;
            height: 200px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
            padding: 12px;
            resize: vertical;
        }

        .insights {
            background: var(--bg-input);
            border-left: 3px solid var(--accent-purple);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
        }

        .insights h4 {
            color: var(--accent-purple);
            margin-bottom: 10px;
            font-size: 12px;
        }

        .insights ul {
            list-style: none;
            font-size: 12px;
            line-height: 1.8;
        }

        .insights li::before {
            content: ">";
            color: var(--accent-purple);
            margin-right: 8px;
        }

        .insights .warning { color: var(--accent-yellow); }
        .insights .danger { color: var(--accent-red); }
        .insights .success { color: var(--accent-green); }

        .metric-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .metric-table th {
            text-align: left;
            padding: 8px;
            background: var(--bg-input);
            color: var(--accent-cyan);
            border-bottom: 1px solid var(--border);
        }

        .metric-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .metric-table td:first-child {
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <h1>BALANCE SIMULATOR</h1>
    <p class="subtitle">Defend & Descend // System: Reboot</p>

    <div class="tabs">
        <div class="tab active" data-panel="waves">Wave Scaling</div>
        <div class="tab" data-panel="threat">Threat Level</div>
        <div class="tab" data-panel="towers">Tower DPS</div>
        <div class="tab" data-panel="economy">Economy</div>
        <div class="tab" data-panel="drops">Drop Rates</div>
        <div class="tab" data-panel="export">Export/Import</div>
    </div>

    <!-- WAVE SCALING PANEL -->
    <div id="waves" class="panel active">
        <div class="section-intro">
            <h2>Wave Scaling (Firewall Mode)</h2>
            <p>Controls how enemies get stronger each wave in TD/Firewall mode. Each wave, enemy HP and speed increase by a percentage of their base values.</p>
            <p><strong>Formula:</strong></p>
            <div class="formula">enemyHP = baseHP × (1 + (waveNumber - 1) × healthScaling)</div>
            <p>Example: At wave 10 with 15% scaling: HP = 20 × (1 + 9 × 0.15) = 20 × 2.35 = 47 HP</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Wave Configuration</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Health Scaling / Wave</label>
                        <input type="number" id="wave-health-scaling" value="0.15" step="0.01">
                        <div class="input-help">% HP increase per wave (0.15 = +15%)</div>
                    </div>
                    <div class="input-group">
                        <label>Speed Scaling / Wave</label>
                        <input type="number" id="wave-speed-scaling" value="0.02" step="0.01">
                        <div class="input-help">% speed increase per wave (0.02 = +2%)</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Base Enemy Count</label>
                        <input type="number" id="wave-base-count" value="5">
                        <div class="input-help">Enemies in wave 1</div>
                    </div>
                    <div class="input-group">
                        <label>Enemies / Wave</label>
                        <input type="number" id="wave-enemies-per" value="2">
                        <div class="input-help">Additional enemies per wave</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Boss Wave Interval</label>
                        <input type="number" id="wave-boss-interval" value="5">
                        <div class="input-help">Boss appears every N waves</div>
                    </div>
                    <div class="input-group">
                        <label>Boss HP Multiplier</label>
                        <input type="number" id="wave-boss-hp-mult" value="2.0" step="0.1">
                        <div class="input-help">Boss HP = enemy HP × this</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Base Enemy HP (from GameConfig)</label>
                    <input type="number" id="wave-base-hp" value="20">
                    <div class="input-help">Starting HP of basic enemy</div>
                </div>
                <div class="button-row">
                    <button onclick="updateWaveChart()">Update Chart</button>
                </div>
            </div>

            <div class="card">
                <h3>Wave Analysis</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="wave-stat-w10-hp">-</div>
                        <div class="stat-label">Wave 10 HP</div>
                        <div class="stat-help">Single enemy HP at wave 10</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="wave-stat-w20-hp">-</div>
                        <div class="stat-label">Wave 20 HP</div>
                        <div class="stat-help">Single enemy HP at wave 20</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="wave-stat-w10-total">-</div>
                        <div class="stat-label">Wave 10 Total HP</div>
                        <div class="stat-help">All enemies combined</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="wave-stat-w20-total">-</div>
                        <div class="stat-label">Wave 20 Total HP</div>
                        <div class="stat-help">All enemies combined</div>
                    </div>
                </div>
                <div class="insights" id="wave-insights">
                    <h4>AI Insights</h4>
                    <ul id="wave-insights-list"></ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Enemy HP Over Waves</h3>
            <div class="chart-description">
                <strong>What this shows:</strong> How enemy HP grows across 20 waves.
                <br><br>
                <span class="legend-item"><span class="legend-color" style="background:#00d4ff"></span>Enemy HP (left axis) - Single enemy health</span>
                <span class="legend-item"><span class="legend-color" style="background:#a855f7"></span>Total Wave HP (right axis) - HP × enemy count</span>
                <br><br>
                <strong>Goal:</strong> HP should grow 3-5× by wave 20. More feels "spongy", less feels too easy.
            </div>
            <div class="chart-container">
                <canvas id="waveChart"></canvas>
            </div>
        </div>
    </div>

    <!-- THREAT LEVEL PANEL -->
    <div id="threat" class="panel">
        <div class="section-intro">
            <h2>Threat Level Scaling (Idle TD Mode)</h2>
            <p>In idle/endless mode, threat level increases over time. Higher threat = stronger enemies and new enemy types unlock.</p>
            <p><strong>Formula:</strong></p>
            <div class="formula">threatLevel = timeInSeconds × growthRate</div>
            <p>Threat unlocks new enemy types at thresholds. At threat 5.0, tank enemies start appearing.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Threat Level Configuration</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>HP Scaling / Threat</label>
                        <input type="number" id="threat-hp-scaling" value="0.15" step="0.01">
                        <div class="input-help">+15% HP per threat level</div>
                    </div>
                    <div class="input-group">
                        <label>Speed Scaling / Threat</label>
                        <input type="number" id="threat-speed-scaling" value="0.02" step="0.01">
                        <div class="input-help">+2% speed per threat level</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Damage Scaling / Threat</label>
                        <input type="number" id="threat-damage-scaling" value="0.05" step="0.01">
                        <div class="input-help">+5% enemy damage per threat</div>
                    </div>
                    <div class="input-group">
                        <label>Threat Growth Rate</label>
                        <input type="number" id="threat-growth-rate" value="0.1" step="0.01">
                        <div class="input-help">Threat per second (0.1 = +6/min)</div>
                    </div>
                </div>
                <h3 style="margin-top:20px">Enemy Type Thresholds</h3>
                <p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px">When each enemy type starts spawning:</p>
                <div class="input-row">
                    <div class="input-group">
                        <label>Fast Enemy</label>
                        <input type="number" id="threat-fast-threshold" value="2.0" step="0.5">
                        <div class="input-help">Quick but weak</div>
                    </div>
                    <div class="input-group">
                        <label>Tank Enemy</label>
                        <input type="number" id="threat-tank-threshold" value="5.0" step="0.5">
                        <div class="input-help">Slow but tanky</div>
                    </div>
                    <div class="input-group">
                        <label>Boss Enemy</label>
                        <input type="number" id="threat-boss-threshold" value="10.0" step="0.5">
                        <div class="input-help">Rare miniboss spawn</div>
                    </div>
                </div>
                <div class="button-row">
                    <button onclick="updateThreatChart()">Update Chart</button>
                </div>
            </div>

            <div class="card">
                <h3>Threat Timeline</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="threat-stat-fast">-</div>
                        <div class="stat-label">Fast @ (min)</div>
                        <div class="stat-help">When fast enemies appear</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="threat-stat-tank">-</div>
                        <div class="stat-label">Tank @ (min)</div>
                        <div class="stat-help">When tank enemies appear</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="threat-stat-boss">-</div>
                        <div class="stat-label">Boss @ (min)</div>
                        <div class="stat-help">When boss enemies appear</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="threat-stat-5min">-</div>
                        <div class="stat-label">HP @ 5min</div>
                        <div class="stat-help">HP multiplier at 5 minutes</div>
                    </div>
                </div>
                <div class="insights" id="threat-insights">
                    <h4>AI Insights</h4>
                    <ul id="threat-insights-list"></ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Stat Multipliers Over Threat Level</h3>
            <div class="chart-description">
                <strong>What this shows:</strong> How enemy stats scale as threat level increases from 1 to 20.
                <br><br>
                <span class="legend-item"><span class="legend-color" style="background:#ef4444"></span>HP Multiplier - Enemy health scaling</span>
                <span class="legend-item"><span class="legend-color" style="background:#22c55e"></span>Speed Multiplier - Movement speed</span>
                <span class="legend-item"><span class="legend-color" style="background:#eab308"></span>Damage Multiplier - Attack damage</span>
                <br><br>
                <strong>X-Axis:</strong> Threat Level (1-20)<br>
                <strong>Y-Axis:</strong> Multiplier (1.0 = base stats)
            </div>
            <div class="chart-container">
                <canvas id="threatChart"></canvas>
            </div>
        </div>
    </div>

    <!-- TOWER DPS PANEL -->
    <div id="towers" class="panel">
        <div class="section-intro">
            <h2>Tower DPS Analysis</h2>
            <p>Compare tower damage output against enemy HP to check if towers can keep up with scaling.</p>
            <p><strong>DPS Formula:</strong></p>
            <div class="formula">DPS = damage × attackSpeed × projectileCount</div>
            <p><strong>TTK (Time To Kill):</strong></p>
            <div class="formula">TTK = enemyHP / DPS</div>
            <p>If TTK exceeds 5 seconds, enemies feel too tanky. If TTK is under 0.5s, enemies die instantly.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Tower Stats (Protocol)</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Base Damage</label>
                        <input type="number" id="tower-damage" value="15">
                        <div class="input-help">Damage per hit</div>
                    </div>
                    <div class="input-group">
                        <label>Attack Speed (per sec)</label>
                        <input type="number" id="tower-attack-speed" value="1.5" step="0.1">
                        <div class="input-help">Attacks per second</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Projectile Count</label>
                        <input type="number" id="tower-projectiles" value="1">
                        <div class="input-help">Shots fired per attack</div>
                    </div>
                    <div class="input-group">
                        <label>Pierce</label>
                        <input type="number" id="tower-pierce" value="0">
                        <div class="input-help">Enemies hit per projectile</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Splash Radius (0=none)</label>
                        <input type="number" id="tower-splash" value="0">
                        <div class="input-help">AoE damage radius</div>
                    </div>
                    <div class="input-group">
                        <label>Tower Level</label>
                        <input type="number" id="tower-level" value="1" min="1" max="10">
                        <div class="input-help">Current upgrade level</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Level Damage Multiplier (per level)</label>
                    <input type="number" id="tower-level-mult" value="0.15" step="0.01">
                    <div class="input-help">+15% damage per level (Lv10 = +135%)</div>
                </div>
                <div class="button-row">
                    <button onclick="updateTowerChart()">Update Chart</button>
                </div>
            </div>

            <div class="card">
                <h3>DPS Analysis</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="tower-stat-dps">-</div>
                        <div class="stat-label">Current Level DPS</div>
                        <div class="stat-help">Damage per second</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="tower-stat-dps-max">-</div>
                        <div class="stat-label">Max Level DPS</div>
                        <div class="stat-help">DPS at level 10</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="tower-stat-ttk-w1">-</div>
                        <div class="stat-label">TTK Wave 1</div>
                        <div class="stat-help">Seconds to kill 1 enemy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="tower-stat-ttk-w10">-</div>
                        <div class="stat-label">TTK Wave 10</div>
                        <div class="stat-help">Seconds to kill 1 enemy</div>
                    </div>
                </div>
                <div class="insights" id="tower-insights">
                    <h4>AI Insights</h4>
                    <ul id="tower-insights-list"></ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Tower DPS vs Enemy HP (by Wave)</h3>
            <div class="chart-description">
                <strong>What this shows:</strong> Tower DPS (flat lines) vs enemy HP (growing line) across waves.
                <br><br>
                <span class="legend-item"><span class="legend-color" style="background:#ef4444"></span>Enemy HP - Health per enemy (grows with waves)</span>
                <span class="legend-item"><span class="legend-color" style="background:#00d4ff"></span>Tower DPS (current) - Your tower's output</span>
                <span class="legend-item"><span class="legend-color" style="background:#22c55e"></span>Max Tower DPS - Fully upgraded tower</span>
                <br><br>
                <strong>Goal:</strong> Tower DPS should stay competitive with enemy HP. If HP line goes way above DPS line, you need more towers.
            </div>
            <div class="chart-container">
                <canvas id="towerChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ECONOMY PANEL -->
    <div id="economy" class="panel">
        <div class="section-intro">
            <h2>Economy & Hash Income</h2>
            <p>Hash is earned passively in Survival mode and as bonuses in Firewall mode. This panel simulates how much you'll earn over time.</p>
            <p><strong>Survival Mode Formula:</strong></p>
            <div class="formula">hashRate = baseRate + (minutesSurvived × bonusPerMinute)</div>
            <p>Example: At 5 minutes with base 2.0 and +0.5/min: rate = 2.0 + (5 × 0.5) = 4.5 Hash/sec</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Economy Configuration</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Hash / Second (Survival)</label>
                        <input type="number" id="econ-hash-per-sec" value="2.0" step="0.5">
                        <div class="input-help">Base passive income rate</div>
                    </div>
                    <div class="input-group">
                        <label>Hash Bonus / Minute</label>
                        <input type="number" id="econ-hash-bonus" value="0.5" step="0.1">
                        <div class="input-help">Added to rate each minute</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Hash / Wave Bonus</label>
                        <input type="number" id="econ-wave-bonus" value="10">
                        <div class="input-help">Bonus = waveNum × this value</div>
                    </div>
                    <div class="input-group">
                        <label>Extraction Time (sec)</label>
                        <input type="number" id="econ-extraction" value="180">
                        <div class="input-help">When you can safely exit</div>
                    </div>
                </div>
                <h3 style="margin-top:20px">Tower Placement Costs</h3>
                <p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px">Hash required to place a tower:</p>
                <div class="input-row">
                    <div class="input-group">
                        <label>Common</label>
                        <input type="number" id="econ-cost-common" value="50">
                    </div>
                    <div class="input-group">
                        <label>Rare</label>
                        <input type="number" id="econ-cost-rare" value="100">
                    </div>
                    <div class="input-group">
                        <label>Epic</label>
                        <input type="number" id="econ-cost-epic" value="200">
                    </div>
                    <div class="input-group">
                        <label>Legendary</label>
                        <input type="number" id="econ-cost-legendary" value="400">
                    </div>
                </div>
                <div class="button-row">
                    <button onclick="updateEconomyChart()">Update Chart</button>
                </div>
            </div>

            <div class="card">
                <h3>Economy Analysis</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="econ-stat-3min">-</div>
                        <div class="stat-label">Hash @ 3min</div>
                        <div class="stat-help">Total at extraction</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="econ-stat-5min">-</div>
                        <div class="stat-label">Hash @ 5min</div>
                        <div class="stat-help">Total at 5 minutes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="econ-stat-rare-time">-</div>
                        <div class="stat-label">Time to Rare</div>
                        <div class="stat-help">Seconds to afford</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="econ-stat-epic-time">-</div>
                        <div class="stat-label">Time to Epic</div>
                        <div class="stat-help">Seconds to afford</div>
                    </div>
                </div>
                <div class="insights" id="econ-insights">
                    <h4>AI Insights</h4>
                    <ul id="econ-insights-list"></ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Hash Income Over Time (Survival Mode)</h3>
            <div class="chart-description">
                <strong>What this shows:</strong> Cumulative Hash earned over a 10-minute survival run.
                <br><br>
                <span class="legend-item"><span class="legend-color" style="background:#00d4ff"></span>Total Hash Earned - Running total</span>
                <br><br>
                <strong>X-Axis:</strong> Time (minutes)<br>
                <strong>Y-Axis:</strong> Total Hash accumulated<br><br>
                <strong>Note:</strong> The curve accelerates because bonus/minute stacks.
            </div>
            <div class="chart-container">
                <canvas id="economyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- DROP RATES PANEL -->
    <div id="drops" class="panel">
        <div class="section-intro">
            <h2>Blueprint Drop Rates</h2>
            <p>When you defeat a boss, RNG determines if you get a blueprint drop. Rates are affected by difficulty and diminishing returns.</p>
            <p><strong>Drop Rate Formula:</strong></p>
            <div class="formula">effectiveRate = baseRate × difficultyMult × (1 / (1 + diminishingFactor × killCount))</div>
            <p><strong>Special Rules:</strong></p>
            <ul style="margin-left:20px;font-size:12px;color:var(--text-secondary)">
                <li>First boss kill = guaranteed drop</li>
                <li>Pity system = guaranteed after N kills without drop</li>
                <li>Already-owned blueprints excluded from pool</li>
            </ul>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Drop Rate Configuration</h3>
                <p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px">Base chance for each rarity (before modifiers):</p>
                <div class="input-row">
                    <div class="input-group">
                        <label>Common Rate</label>
                        <input type="number" id="drop-common" value="0.60" step="0.05">
                        <div class="input-help">60% = 0.60</div>
                    </div>
                    <div class="input-group">
                        <label>Rare Rate</label>
                        <input type="number" id="drop-rare" value="0.30" step="0.05">
                        <div class="input-help">30% = 0.30</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Epic Rate</label>
                        <input type="number" id="drop-epic" value="0.08" step="0.01">
                        <div class="input-help">8% = 0.08</div>
                    </div>
                    <div class="input-group">
                        <label>Legendary Rate</label>
                        <input type="number" id="drop-legendary" value="0.02" step="0.01">
                        <div class="input-help">2% = 0.02</div>
                    </div>
                </div>
                <h3 style="margin-top:20px">Difficulty Multipliers</h3>
                <p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px">Drop rate × this value based on difficulty:</p>
                <div class="input-row">
                    <div class="input-group">
                        <label>Easy</label>
                        <input type="number" id="drop-mult-easy" value="0.5" step="0.1">
                        <div class="input-help">50% of base rates</div>
                    </div>
                    <div class="input-group">
                        <label>Normal</label>
                        <input type="number" id="drop-mult-normal" value="1.0" step="0.1">
                        <div class="input-help">100% (baseline)</div>
                    </div>
                    <div class="input-group">
                        <label>Hard</label>
                        <input type="number" id="drop-mult-hard" value="1.5" step="0.1">
                        <div class="input-help">150% of base rates</div>
                    </div>
                    <div class="input-group">
                        <label>Nightmare</label>
                        <input type="number" id="drop-mult-nightmare" value="2.5" step="0.1">
                        <div class="input-help">250% of base rates</div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Diminishing Factor</label>
                        <input type="number" id="drop-diminishing" value="0.1" step="0.01">
                        <div class="input-help">How fast rates decay (0.1 = slow)</div>
                    </div>
                    <div class="input-group">
                        <label>Pity Threshold (kills)</label>
                        <input type="number" id="drop-pity" value="10">
                        <div class="input-help">Guaranteed drop after N misses</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Monte Carlo Simulation</h3>
                <p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px">Simulate many boss kills to see actual drop distribution:</p>
                <div class="input-row">
                    <div class="input-group">
                        <label>Simulated Kills</label>
                        <input type="number" id="sim-kills" value="1000">
                        <div class="input-help">More = more accurate</div>
                    </div>
                    <div class="input-group">
                        <label>Difficulty</label>
                        <select id="sim-difficulty" style="width:100%;padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary)">
                            <option value="easy">Easy</option>
                            <option value="normal" selected>Normal</option>
                            <option value="hard">Hard</option>
                            <option value="nightmare">Nightmare</option>
                        </select>
                    </div>
                </div>
                <div class="button-row">
                    <button onclick="runDropSimulation()">Run Simulation</button>
                </div>

                <div class="drop-results" id="drop-results"></div>
            </div>
        </div>

        <div class="card">
            <h3>Drop Rate Decay (Diminishing Returns)</h3>
            <div class="chart-description">
                <strong>What this shows:</strong> How drop rates decrease over consecutive boss kills due to diminishing returns.
                <br><br>
                <span class="legend-item"><span class="legend-color" style="background:#71717a"></span>Common % chance</span>
                <span class="legend-item"><span class="legend-color" style="background:#3b82f6"></span>Rare % chance</span>
                <span class="legend-item"><span class="legend-color" style="background:#a855f7"></span>Epic % chance</span>
                <span class="legend-item"><span class="legend-color" style="background:#eab308"></span>Legendary % chance</span>
                <br><br>
                <strong>X-Axis:</strong> Kill number (1-20)<br>
                <strong>Y-Axis:</strong> Drop chance percentage<br><br>
                <strong>Note:</strong> This doesn't show pity - just the raw diminishing formula.
            </div>
            <div class="chart-container">
                <canvas id="dropChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Simulation Log (First 20 Kills)</h3>
            <div class="simulation-log" id="simulation-log">
                Run a simulation to see detailed results...
            </div>
        </div>
    </div>

    <!-- EXPORT/IMPORT PANEL -->
    <div id="export" class="panel">
        <div class="section-intro">
            <h2>Export / Import Configuration</h2>
            <p>Export your settings as JSON to share or backup. Import JSON from BalanceConfig.swift's exportJSON() function.</p>
            <p>The Swift Code Generator creates copy-paste ready code for updating BalanceConfig.swift directly.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Export Configuration</h3>
                <p style="color:var(--text-secondary);font-size:12px;margin-bottom:15px">
                    Copy this JSON and update BalanceConfig.swift
                </p>
                <textarea class="export-area" id="export-json" readonly></textarea>
                <div class="button-row">
                    <button onclick="generateExport()">Generate Export</button>
                    <button class="secondary" onclick="copyExport()">Copy to Clipboard</button>
                </div>
            </div>

            <div class="card">
                <h3>Import Configuration</h3>
                <p style="color:var(--text-secondary);font-size:12px;margin-bottom:15px">
                    Paste JSON to load values into the simulator
                </p>
                <textarea class="export-area" id="import-json" placeholder="Paste JSON here..."></textarea>
                <div class="button-row">
                    <button onclick="importConfig()">Import</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Swift Code Generation</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:15px">
                Copy-paste ready Swift code for BalanceConfig.swift
            </p>
            <textarea class="export-area" id="swift-export" readonly style="height:300px"></textarea>
            <div class="button-row">
                <button onclick="generateSwiftExport()">Generate Swift Code</button>
                <button class="secondary" onclick="copySwiftExport()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        // Charts
        let waveChart, threatChart, towerChart, economyChart, dropChart;

        // Initialize on load
        window.addEventListener('load', () => {
            initCharts();
            updateWaveChart();
            updateThreatChart();
            updateTowerChart();
            updateEconomyChart();
            updateDropChart();
        });

        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#a1a1aa' } }
                },
                scales: {
                    x: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: '#27272a' },
                        title: { display: true, color: '#a1a1aa' }
                    },
                    y: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: '#27272a' },
                        title: { display: true, color: '#a1a1aa' }
                    }
                }
            };

            waveChart = new Chart(document.getElementById('waveChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, title: { display: true, text: 'Wave Number', color: '#a1a1aa' } },
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'Enemy HP', color: '#a1a1aa' } }
                    }
                }
            });

            threatChart = new Chart(document.getElementById('threatChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, title: { display: true, text: 'Threat Level', color: '#a1a1aa' } },
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'Stat Multiplier', color: '#a1a1aa' } }
                    }
                }
            });

            towerChart = new Chart(document.getElementById('towerChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, title: { display: true, text: 'Wave Number', color: '#a1a1aa' } },
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'HP / DPS', color: '#a1a1aa' } }
                    }
                }
            });

            economyChart = new Chart(document.getElementById('economyChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, title: { display: true, text: 'Time (minutes)', color: '#a1a1aa' } },
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'Total Hash', color: '#a1a1aa' } }
                    }
                }
            });

            dropChart = new Chart(document.getElementById('dropChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, title: { display: true, text: 'Kill Number', color: '#a1a1aa' } },
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'Drop Chance (%)', color: '#a1a1aa' } }
                    }
                }
            });
        }

        function updateWaveChart() {
            const healthScaling = parseFloat(document.getElementById('wave-health-scaling').value);
            const speedScaling = parseFloat(document.getElementById('wave-speed-scaling').value);
            const baseCount = parseInt(document.getElementById('wave-base-count').value);
            const enemiesPerWave = parseInt(document.getElementById('wave-enemies-per').value);
            const bossInterval = parseInt(document.getElementById('wave-boss-interval').value);
            const bossHpMult = parseFloat(document.getElementById('wave-boss-hp-mult').value);
            const baseHp = parseFloat(document.getElementById('wave-base-hp').value);

            const waves = [];
            const hpData = [];
            const speedData = [];
            const totalHpData = [];

            for (let w = 1; w <= 20; w++) {
                waves.push(w);
                const hpMult = 1 + (w - 1) * healthScaling;
                const speedMult = 1 + (w - 1) * speedScaling;
                const enemyCount = baseCount + w * enemiesPerWave;
                const isBoss = w % bossInterval === 0;

                hpData.push(baseHp * hpMult * (isBoss ? bossHpMult : 1));
                speedData.push(speedMult);
                totalHpData.push(baseHp * hpMult * enemyCount);
            }

            waveChart.data.labels = waves;
            waveChart.data.datasets = [
                {
                    label: 'Enemy HP',
                    data: hpData,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0,212,255,0.1)',
                    fill: true
                },
                {
                    label: 'Total Wave HP',
                    data: totalHpData,
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168,85,247,0.1)',
                    fill: true,
                    yAxisID: 'y1'
                }
            ];
            waveChart.options.scales.y1 = {
                position: 'right',
                ticks: { color: '#a1a1aa' },
                grid: { display: false },
                title: { display: true, text: 'Total Wave HP', color: '#a1a1aa' }
            };
            waveChart.update();

            // Update stats
            document.getElementById('wave-stat-w10-hp').textContent = hpData[9].toFixed(0);
            document.getElementById('wave-stat-w20-hp').textContent = hpData[19].toFixed(0);
            document.getElementById('wave-stat-w10-total').textContent = totalHpData[9].toFixed(0);
            document.getElementById('wave-stat-w20-total').textContent = totalHpData[19].toFixed(0);

            // Generate insights
            const insights = [];
            const w10Growth = hpData[9] / hpData[0];
            const w20Growth = hpData[19] / hpData[0];

            if (w20Growth > 5) {
                insights.push({ class: 'warning', text: `Wave 20 enemies have ${w20Growth.toFixed(1)}x HP - may feel too spongy` });
            } else if (w20Growth < 2) {
                insights.push({ class: 'warning', text: `Wave 20 only ${w20Growth.toFixed(1)}x HP - late game may be too easy` });
            } else {
                insights.push({ class: 'success', text: `Scaling looks balanced (${w20Growth.toFixed(1)}x at wave 20)` });
            }

            if (bossInterval > 7) {
                insights.push({ class: 'warning', text: `Boss every ${bossInterval} waves - players may get bored` });
            }

            document.getElementById('wave-insights-list').innerHTML =
                insights.map(i => `<li class="${i.class}">${i.text}</li>`).join('');
        }

        function updateThreatChart() {
            const hpScaling = parseFloat(document.getElementById('threat-hp-scaling').value);
            const speedScaling = parseFloat(document.getElementById('threat-speed-scaling').value);
            const damageScaling = parseFloat(document.getElementById('threat-damage-scaling').value);
            const growthRate = parseFloat(document.getElementById('threat-growth-rate').value);
            const fastThreshold = parseFloat(document.getElementById('threat-fast-threshold').value);
            const tankThreshold = parseFloat(document.getElementById('threat-tank-threshold').value);
            const bossThreshold = parseFloat(document.getElementById('threat-boss-threshold').value);

            const threats = [];
            const hpData = [];
            const speedData = [];
            const damageData = [];

            for (let t = 1; t <= 20; t++) {
                threats.push(t);
                hpData.push(1 + (t - 1) * hpScaling);
                speedData.push(1 + (t - 1) * speedScaling);
                damageData.push(1 + (t - 1) * damageScaling);
            }

            threatChart.data.labels = threats;
            threatChart.data.datasets = [
                { label: 'HP Multiplier', data: hpData, borderColor: '#ef4444' },
                { label: 'Speed Multiplier', data: speedData, borderColor: '#22c55e' },
                { label: 'Damage Multiplier', data: damageData, borderColor: '#eab308' }
            ];
            threatChart.update();

            // Calculate time to reach thresholds
            const fastTime = fastThreshold / growthRate / 60;
            const tankTime = tankThreshold / growthRate / 60;
            const bossTime = bossThreshold / growthRate / 60;
            const threat5min = 5 * 60 * growthRate;
            const hp5min = 1 + (threat5min - 1) * hpScaling;

            document.getElementById('threat-stat-fast').textContent = fastTime.toFixed(1);
            document.getElementById('threat-stat-tank').textContent = tankTime.toFixed(1);
            document.getElementById('threat-stat-boss').textContent = bossTime.toFixed(1);
            document.getElementById('threat-stat-5min').textContent = hp5min.toFixed(1) + 'x';

            // Insights
            const insights = [];
            if (fastTime < 0.5) {
                insights.push({ class: 'warning', text: 'Fast enemies appear very quickly - new players may struggle' });
            }
            if (bossTime > 10) {
                insights.push({ class: 'danger', text: `Boss enemies take ${bossTime.toFixed(0)} min to appear - too slow?` });
            }
            if (hp5min > 2) {
                insights.push({ class: 'success', text: `Good difficulty curve: ${hp5min.toFixed(1)}x HP at 5 minutes` });
            }

            document.getElementById('threat-insights-list').innerHTML =
                insights.map(i => `<li class="${i.class}">${i.text}</li>`).join('');
        }

        function updateTowerChart() {
            const damage = parseFloat(document.getElementById('tower-damage').value);
            const attackSpeed = parseFloat(document.getElementById('tower-attack-speed').value);
            const projectiles = parseInt(document.getElementById('tower-projectiles').value);
            const pierce = parseInt(document.getElementById('tower-pierce').value);
            const level = parseInt(document.getElementById('tower-level').value);
            const levelMult = parseFloat(document.getElementById('tower-level-mult').value);

            const healthScaling = parseFloat(document.getElementById('wave-health-scaling').value);
            const baseHp = parseFloat(document.getElementById('wave-base-hp').value);

            const baseDps = damage * attackSpeed * projectiles;
            const levelDamage = damage * (1 + (level - 1) * levelMult);
            const levelDps = levelDamage * attackSpeed * projectiles;
            const maxDps = damage * (1 + 9 * levelMult) * attackSpeed * projectiles;

            const waves = [];
            const enemyHpData = [];
            const dpsLine = [];
            const maxDpsLine = [];
            const ttkData = [];

            for (let w = 1; w <= 20; w++) {
                waves.push(w);
                const hpMult = 1 + (w - 1) * healthScaling;
                const hp = baseHp * hpMult;
                enemyHpData.push(hp);
                dpsLine.push(levelDps);
                maxDpsLine.push(maxDps);
                ttkData.push(hp / levelDps);
            }

            towerChart.data.labels = waves;
            towerChart.data.datasets = [
                { label: 'Enemy HP', data: enemyHpData, borderColor: '#ef4444', fill: false },
                { label: `Tower DPS (Lv${level})`, data: dpsLine, borderColor: '#00d4ff', borderDash: [5,5] },
                { label: 'Max Tower DPS (Lv10)', data: maxDpsLine, borderColor: '#22c55e', borderDash: [5,5] }
            ];
            towerChart.update();

            // Stats
            document.getElementById('tower-stat-dps').textContent = levelDps.toFixed(1);
            document.getElementById('tower-stat-dps-max').textContent = maxDps.toFixed(1);
            document.getElementById('tower-stat-ttk-w1').textContent = (enemyHpData[0] / levelDps).toFixed(2) + 's';
            document.getElementById('tower-stat-ttk-w10').textContent = (enemyHpData[9] / levelDps).toFixed(2) + 's';

            // Insights
            const insights = [];
            const ttkW10 = enemyHpData[9] / levelDps;
            const ttkW20 = enemyHpData[19] / levelDps;

            if (ttkW10 > 5) {
                insights.push({ class: 'danger', text: `TTK at wave 10 is ${ttkW10.toFixed(1)}s - enemies feel too tanky` });
            }
            if (ttkW20 / ttkData[0] > 10) {
                insights.push({ class: 'warning', text: 'TTK grows too fast - tower upgrades may not keep up' });
            }
            if (maxDps < enemyHpData[19] / 3) {
                insights.push({ class: 'danger', text: 'Max DPS cannot kill wave 20 enemies in 3s - need more towers or scaling' });
            } else {
                insights.push({ class: 'success', text: 'Tower scaling keeps up with enemy HP growth' });
            }

            document.getElementById('tower-insights-list').innerHTML =
                insights.map(i => `<li class="${i.class}">${i.text}</li>`).join('');
        }

        function updateEconomyChart() {
            const hashPerSec = parseFloat(document.getElementById('econ-hash-per-sec').value);
            const hashBonus = parseFloat(document.getElementById('econ-hash-bonus').value);
            const waveBonus = parseInt(document.getElementById('econ-wave-bonus').value);
            const extraction = parseInt(document.getElementById('econ-extraction').value);

            const costCommon = parseInt(document.getElementById('econ-cost-common').value);
            const costRare = parseInt(document.getElementById('econ-cost-rare').value);
            const costEpic = parseInt(document.getElementById('econ-cost-epic').value);
            const costLegendary = parseInt(document.getElementById('econ-cost-legendary').value);

            const times = [];
            const hashData = [];
            let totalHash = 0;

            for (let sec = 0; sec <= 600; sec += 30) {
                times.push(sec / 60);
                const minutes = sec / 60;
                const rate = hashPerSec + minutes * hashBonus;
                totalHash += rate * 30;
                hashData.push(Math.floor(totalHash));
            }

            economyChart.data.labels = times;
            economyChart.data.datasets = [
                {
                    label: 'Total Hash Earned',
                    data: hashData,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0,212,255,0.1)',
                    fill: true
                }
            ];
            economyChart.update();

            // Stats
            const hash3min = hashData[6]; // 180s / 30 = 6
            const hash5min = hashData[10]; // 300s / 30 = 10

            document.getElementById('econ-stat-3min').textContent = hash3min;
            document.getElementById('econ-stat-5min').textContent = hash5min;

            // Time to afford each rarity
            function timeToAfford(cost) {
                for (let i = 0; i < hashData.length; i++) {
                    if (hashData[i] >= cost) return (i * 30) + 's';
                }
                return '>10m';
            }

            document.getElementById('econ-stat-rare-time').textContent = timeToAfford(costRare);
            document.getElementById('econ-stat-epic-time').textContent = timeToAfford(costEpic);

            // Insights
            const insights = [];
            if (hash3min < costRare) {
                insights.push({ class: 'warning', text: `Can't afford Rare tower by extraction (${extraction}s)` });
            }
            if (hash5min < costEpic) {
                insights.push({ class: 'warning', text: "Epic towers may be unreachable in typical 5min runs" });
            }
            if (hashBonus > hashPerSec / 2) {
                insights.push({ class: 'success', text: 'Good late-game acceleration with bonus/minute' });
            }

            document.getElementById('econ-insights-list').innerHTML =
                insights.map(i => `<li class="${i.class}">${i.text}</li>`).join('');
        }

        function updateDropChart() {
            const baseCommon = parseFloat(document.getElementById('drop-common').value);
            const baseRare = parseFloat(document.getElementById('drop-rare').value);
            const baseEpic = parseFloat(document.getElementById('drop-epic').value);
            const baseLegendary = parseFloat(document.getElementById('drop-legendary').value);
            const diminishing = parseFloat(document.getElementById('drop-diminishing').value);

            const kills = [];
            const commonData = [];
            const rareData = [];
            const epicData = [];
            const legendaryData = [];

            for (let k = 1; k <= 20; k++) {
                kills.push(k);
                const dim = 1 / (1 + diminishing * k);
                commonData.push(baseCommon * dim * 100);
                rareData.push(baseRare * dim * 100);
                epicData.push(baseEpic * dim * 100);
                legendaryData.push(baseLegendary * dim * 100);
            }

            dropChart.data.labels = kills;
            dropChart.data.datasets = [
                { label: 'Common %', data: commonData, borderColor: '#71717a' },
                { label: 'Rare %', data: rareData, borderColor: '#3b82f6' },
                { label: 'Epic %', data: epicData, borderColor: '#a855f7' },
                { label: 'Legendary %', data: legendaryData, borderColor: '#eab308' }
            ];
            dropChart.update();
        }

        function runDropSimulation() {
            const kills = parseInt(document.getElementById('sim-kills').value);
            const difficulty = document.getElementById('sim-difficulty').value;

            const baseCommon = parseFloat(document.getElementById('drop-common').value);
            const baseRare = parseFloat(document.getElementById('drop-rare').value);
            const baseEpic = parseFloat(document.getElementById('drop-epic').value);
            const baseLegendary = parseFloat(document.getElementById('drop-legendary').value);
            const diminishing = parseFloat(document.getElementById('drop-diminishing').value);
            const pity = parseInt(document.getElementById('drop-pity').value);

            const diffMults = {
                easy: parseFloat(document.getElementById('drop-mult-easy').value),
                normal: parseFloat(document.getElementById('drop-mult-normal').value),
                hard: parseFloat(document.getElementById('drop-mult-hard').value),
                nightmare: parseFloat(document.getElementById('drop-mult-nightmare').value)
            };

            const diffMult = diffMults[difficulty];

            let results = { common: 0, rare: 0, epic: 0, legendary: 0, none: 0 };
            let killsSinceLastDrop = 0;
            let log = [];

            for (let k = 1; k <= kills; k++) {
                killsSinceLastDrop++;
                const dim = 1 / (1 + diminishing * k);

                // Pity check
                if (killsSinceLastDrop >= pity) {
                    results.common++;
                    killsSinceLastDrop = 0;
                    if (k <= 20) log.push({ kill: k, type: 'pity', rarity: 'common' });
                    continue;
                }

                const roll = Math.random();
                let cumulative = 0;

                // Legendary
                cumulative += baseLegendary * diffMult * dim;
                if (roll < cumulative) {
                    results.legendary++;
                    killsSinceLastDrop = 0;
                    if (k <= 20) log.push({ kill: k, type: 'drop', rarity: 'legendary' });
                    continue;
                }

                // Epic
                cumulative += baseEpic * diffMult * dim;
                if (roll < cumulative) {
                    results.epic++;
                    killsSinceLastDrop = 0;
                    if (k <= 20) log.push({ kill: k, type: 'drop', rarity: 'epic' });
                    continue;
                }

                // Rare
                cumulative += baseRare * diffMult * dim;
                if (roll < cumulative) {
                    results.rare++;
                    killsSinceLastDrop = 0;
                    if (k <= 20) log.push({ kill: k, type: 'drop', rarity: 'rare' });
                    continue;
                }

                // Common
                cumulative += baseCommon * diffMult * dim;
                if (roll < cumulative) {
                    results.common++;
                    killsSinceLastDrop = 0;
                    if (k <= 20) log.push({ kill: k, type: 'drop', rarity: 'common' });
                    continue;
                }

                results.none++;
                if (k <= 20) log.push({ kill: k, type: 'none' });
            }

            // Render results
            const total = kills;
            const dropTotal = results.common + results.rare + results.epic + results.legendary;
            document.getElementById('drop-results').innerHTML = `
                <div class="drop-bar rarity-common">
                    <div class="drop-bar-label">Common</div>
                    <div class="drop-bar-track"><div class="drop-bar-fill" style="width:${results.common/total*100}%"></div></div>
                    <div class="drop-bar-value">${(results.common/total*100).toFixed(1)}%</div>
                </div>
                <div class="drop-bar rarity-rare">
                    <div class="drop-bar-label">Rare</div>
                    <div class="drop-bar-track"><div class="drop-bar-fill" style="width:${results.rare/total*100}%"></div></div>
                    <div class="drop-bar-value">${(results.rare/total*100).toFixed(1)}%</div>
                </div>
                <div class="drop-bar rarity-epic">
                    <div class="drop-bar-label">Epic</div>
                    <div class="drop-bar-track"><div class="drop-bar-fill" style="width:${results.epic/total*100}%"></div></div>
                    <div class="drop-bar-value">${(results.epic/total*100).toFixed(1)}%</div>
                </div>
                <div class="drop-bar rarity-legendary">
                    <div class="drop-bar-label">Legendary</div>
                    <div class="drop-bar-track"><div class="drop-bar-fill" style="width:${results.legendary/total*100}%"></div></div>
                    <div class="drop-bar-value">${(results.legendary/total*100).toFixed(1)}%</div>
                </div>
                <div class="drop-bar">
                    <div class="drop-bar-label">No Drop</div>
                    <div class="drop-bar-track"><div class="drop-bar-fill" style="width:${results.none/total*100}%;background:#333"></div></div>
                    <div class="drop-bar-value">${(results.none/total*100).toFixed(1)}%</div>
                </div>
                <table class="metric-table">
                    <tr><th>Metric</th><th>Value</th></tr>
                    <tr><td>Total Drops</td><td>${dropTotal} / ${kills} kills</td></tr>
                    <tr><td>Overall Drop Rate</td><td>${(dropTotal/kills*100).toFixed(1)}%</td></tr>
                    <tr><td>Avg Kills per Drop</td><td>${(kills/dropTotal).toFixed(1)}</td></tr>
                    <tr><td>Legendary Chance</td><td>1 in ${Math.round(kills/Math.max(1,results.legendary))}</td></tr>
                </table>
            `;

            // Render log
            document.getElementById('simulation-log').innerHTML = log.map(l => {
                if (l.type === 'none') {
                    return `<div class="log-entry no-drop">Kill ${l.kill}: No drop</div>`;
                } else if (l.type === 'pity') {
                    return `<div class="log-entry first-kill">Kill ${l.kill}: PITY ${l.rarity.toUpperCase()}</div>`;
                } else {
                    const cls = l.rarity === 'legendary' ? 'legendary' : 'drop';
                    return `<div class="log-entry ${cls}">Kill ${l.kill}: ${l.rarity.toUpperCase()}</div>`;
                }
            }).join('') + `<div style="margin-top:10px;color:#666">... showing first 20 kills ...</div>`;
        }

        function generateExport() {
            const config = {
                waves: {
                    healthScalingPerWave: parseFloat(document.getElementById('wave-health-scaling').value),
                    speedScalingPerWave: parseFloat(document.getElementById('wave-speed-scaling').value),
                    baseEnemyCount: parseInt(document.getElementById('wave-base-count').value),
                    enemiesPerWave: parseInt(document.getElementById('wave-enemies-per').value),
                    bossWaveInterval: parseInt(document.getElementById('wave-boss-interval').value),
                    bossHealthMultiplier: parseFloat(document.getElementById('wave-boss-hp-mult').value)
                },
                threatLevel: {
                    healthScaling: parseFloat(document.getElementById('threat-hp-scaling').value),
                    speedScaling: parseFloat(document.getElementById('threat-speed-scaling').value),
                    damageScaling: parseFloat(document.getElementById('threat-damage-scaling').value),
                    fastEnemyThreshold: parseFloat(document.getElementById('threat-fast-threshold').value),
                    tankEnemyThreshold: parseFloat(document.getElementById('threat-tank-threshold').value),
                    bossEnemyThreshold: parseFloat(document.getElementById('threat-boss-threshold').value)
                },
                survivalEconomy: {
                    hashPerSecond: parseFloat(document.getElementById('econ-hash-per-sec').value),
                    hashBonusPerMinute: parseFloat(document.getElementById('econ-hash-bonus').value),
                    extractionTime: parseInt(document.getElementById('econ-extraction').value)
                },
                towers: {
                    placementCosts: {
                        common: parseInt(document.getElementById('econ-cost-common').value),
                        rare: parseInt(document.getElementById('econ-cost-rare').value),
                        epic: parseInt(document.getElementById('econ-cost-epic').value),
                        legendary: parseInt(document.getElementById('econ-cost-legendary').value)
                    }
                },
                dropRates: {
                    common: parseFloat(document.getElementById('drop-common').value),
                    rare: parseFloat(document.getElementById('drop-rare').value),
                    epic: parseFloat(document.getElementById('drop-epic').value),
                    legendary: parseFloat(document.getElementById('drop-legendary').value),
                    easyMultiplier: parseFloat(document.getElementById('drop-mult-easy').value),
                    normalMultiplier: parseFloat(document.getElementById('drop-mult-normal').value),
                    hardMultiplier: parseFloat(document.getElementById('drop-mult-hard').value),
                    nightmareMultiplier: parseFloat(document.getElementById('drop-mult-nightmare').value),
                    pityThreshold: parseInt(document.getElementById('drop-pity').value),
                    diminishingFactor: parseFloat(document.getElementById('drop-diminishing').value)
                }
            };

            document.getElementById('export-json').value = JSON.stringify(config, null, 2);
        }

        function copyExport() {
            const textarea = document.getElementById('export-json');
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        function importConfig() {
            try {
                const json = document.getElementById('import-json').value;
                const config = JSON.parse(json);

                if (config.waves) {
                    document.getElementById('wave-health-scaling').value = config.waves.healthScalingPerWave ?? 0.15;
                    document.getElementById('wave-speed-scaling').value = config.waves.speedScalingPerWave ?? 0.02;
                    document.getElementById('wave-base-count').value = config.waves.baseEnemyCount ?? 5;
                    document.getElementById('wave-enemies-per').value = config.waves.enemiesPerWave ?? 2;
                    document.getElementById('wave-boss-interval').value = config.waves.bossWaveInterval ?? 5;
                    document.getElementById('wave-boss-hp-mult').value = config.waves.bossHealthMultiplier ?? 2.0;
                }

                if (config.threatLevel) {
                    document.getElementById('threat-hp-scaling').value = config.threatLevel.healthScaling ?? 0.15;
                    document.getElementById('threat-speed-scaling').value = config.threatLevel.speedScaling ?? 0.02;
                    document.getElementById('threat-damage-scaling').value = config.threatLevel.damageScaling ?? 0.05;
                    document.getElementById('threat-fast-threshold').value = config.threatLevel.fastEnemyThreshold ?? 2.0;
                    document.getElementById('threat-tank-threshold').value = config.threatLevel.tankEnemyThreshold ?? 5.0;
                    document.getElementById('threat-boss-threshold').value = config.threatLevel.bossEnemyThreshold ?? 10.0;
                }

                if (config.survivalEconomy) {
                    document.getElementById('econ-hash-per-sec').value = config.survivalEconomy.hashPerSecond ?? 2.0;
                    document.getElementById('econ-hash-bonus').value = config.survivalEconomy.hashBonusPerMinute ?? 0.5;
                    document.getElementById('econ-extraction').value = config.survivalEconomy.extractionTime ?? 180;
                }

                if (config.towers?.placementCosts) {
                    document.getElementById('econ-cost-common').value = config.towers.placementCosts.common ?? 50;
                    document.getElementById('econ-cost-rare').value = config.towers.placementCosts.rare ?? 100;
                    document.getElementById('econ-cost-epic').value = config.towers.placementCosts.epic ?? 200;
                    document.getElementById('econ-cost-legendary').value = config.towers.placementCosts.legendary ?? 400;
                }

                if (config.dropRates) {
                    document.getElementById('drop-common').value = config.dropRates.common ?? 0.60;
                    document.getElementById('drop-rare').value = config.dropRates.rare ?? 0.30;
                    document.getElementById('drop-epic').value = config.dropRates.epic ?? 0.08;
                    document.getElementById('drop-legendary').value = config.dropRates.legendary ?? 0.02;
                    document.getElementById('drop-mult-easy').value = config.dropRates.easyMultiplier ?? 0.5;
                    document.getElementById('drop-mult-normal').value = config.dropRates.normalMultiplier ?? 1.0;
                    document.getElementById('drop-mult-hard').value = config.dropRates.hardMultiplier ?? 1.5;
                    document.getElementById('drop-mult-nightmare').value = config.dropRates.nightmareMultiplier ?? 2.5;
                    document.getElementById('drop-pity').value = config.dropRates.pityThreshold ?? 10;
                    document.getElementById('drop-diminishing').value = config.dropRates.diminishingFactor ?? 0.1;
                }

                // Update all charts
                updateWaveChart();
                updateThreatChart();
                updateTowerChart();
                updateEconomyChart();
                updateDropChart();

                alert('Configuration imported successfully!');
            } catch (e) {
                alert('Error parsing JSON: ' + e.message);
            }
        }

        function generateSwiftExport() {
            const swift = `// Generated by Balance Simulator
// Copy relevant sections to BalanceConfig.swift

struct Waves {
    static let healthScalingPerWave: CGFloat = ${document.getElementById('wave-health-scaling').value}
    static let speedScalingPerWave: CGFloat = ${document.getElementById('wave-speed-scaling').value}
    static let baseEnemyCount: Int = ${document.getElementById('wave-base-count').value}
    static let enemiesPerWave: Int = ${document.getElementById('wave-enemies-per').value}
    static let bossWaveInterval: Int = ${document.getElementById('wave-boss-interval').value}
    static let bossHealthMultiplier: CGFloat = ${document.getElementById('wave-boss-hp-mult').value}
}

struct ThreatLevel {
    static let healthScaling: CGFloat = ${document.getElementById('threat-hp-scaling').value}
    static let speedScaling: CGFloat = ${document.getElementById('threat-speed-scaling').value}
    static let damageScaling: CGFloat = ${document.getElementById('threat-damage-scaling').value}
    static let fastEnemyThreshold: CGFloat = ${document.getElementById('threat-fast-threshold').value}
    static let tankEnemyThreshold: CGFloat = ${document.getElementById('threat-tank-threshold').value}
    static let bossEnemyThreshold: CGFloat = ${document.getElementById('threat-boss-threshold').value}
}

struct SurvivalEconomy {
    static let hashPerSecond: CGFloat = ${document.getElementById('econ-hash-per-sec').value}
    static let hashBonusPerMinute: CGFloat = ${document.getElementById('econ-hash-bonus').value}
    static let extractionTime: TimeInterval = ${document.getElementById('econ-extraction').value}
}

struct Towers {
    static let placementCosts: [Rarity: Int] = [
        .common: ${document.getElementById('econ-cost-common').value},
        .rare: ${document.getElementById('econ-cost-rare').value},
        .epic: ${document.getElementById('econ-cost-epic').value},
        .legendary: ${document.getElementById('econ-cost-legendary').value}
    ]
}

struct DropRates {
    static let common: Double = ${document.getElementById('drop-common').value}
    static let rare: Double = ${document.getElementById('drop-rare').value}
    static let epic: Double = ${document.getElementById('drop-epic').value}
    static let legendary: Double = ${document.getElementById('drop-legendary').value}
    static let easyMultiplier: Double = ${document.getElementById('drop-mult-easy').value}
    static let normalMultiplier: Double = ${document.getElementById('drop-mult-normal').value}
    static let hardMultiplier: Double = ${document.getElementById('drop-mult-hard').value}
    static let nightmareMultiplier: Double = ${document.getElementById('drop-mult-nightmare').value}
    static let pityThreshold: Int = ${document.getElementById('drop-pity').value}
    static let diminishingFactor: Double = ${document.getElementById('drop-diminishing').value}
}`;

            document.getElementById('swift-export').value = swift;
        }

        function copySwiftExport() {
            const textarea = document.getElementById('swift-export');
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }
    </script>
</body>
</html>
